<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Jerakia</title>
    
    <link rel="stylesheet" href="/css/minimal.css">
    <link rel="stylesheet" href="/css/pygment_trac.css">
    <script src="/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <headercontainer>
        <header>
        <h1>Jerakia</h1>
        <p>A versatile data lookup system</p>
        <ul>
          <li><a href="https://rubygems.org/gems/jerakia/">Download <strong>Gem</strong></a></li>
          <li><a href="https://github.com/crayfishx/jerakia">View On <strong>GitHub</strong></a></li>
          <li><a href="https://forge.puppetlabs.com/crayfishx/jerakia">Install with<strong>Puppet</strong></a></li>
        </ul>
        </header>
        <menusection>
        <li><a href="/">Home</a></li>
        <br/>
        <li><a href="/basics">Basics</a></li>
        <ul>
          <li><a href="/basics/install">Installing</a></li>
          <li><a href="/basics/configure">Configuring</a></li>
          <li><a href="/basics/lookups">Understanding Jerakia Lookups</a></li>
          <li><a href="/basics/cli">Command line interface</a></li>
        </ul>
        <li><a href="/tutorial/">Quickstart Tutorial</a></li>
        <ul>
          <li><a href="/tutorial/installing">Installing Jerakia</a></li>
          <li><a href="/tutorial/config">Configuring</a></li>
          <li><a href="/tutorial/policy">Writing a policy</a></li>
          <li><a href="/tutorial/lookup">Writing a lookup</a></li>
          <li><a href="/tutorial/data">Populating data</a></li>
          <li><a href="/tutorial/command1">Running the jerakia command</a></li>
          <li><a href="/tutorial/override">Overriding data in the hierarchy</a></li>
          <li><a href="/tutorial/puppet">Integrating with Puppet</a></li>
        </ul>
        <li><a href="/lookups">Lookups</a></li>
        <ul>
          <li><a href="/lookups/plugins">Using lookup plugins</a></li>
          <li><a class="pending" href="/pending">Hiera lookup plugin</a></li>
          <li><a class="pending" href="/pending">Writing custom lookup plugins</a></li>
        </ul>
        <li><a href="/datasources">Datasources</a></li>
        <ul>
          <li><a href="/datasources/file">File datasource</a></li>
          <li><a href="/datasources/http">HTTP datasource</a></li>
          <li><a href="/datasources/dummy">Dummy datasource</a></li>
          <li><a class="pending" href="/pending">Writing datasources</a></li>
        </ul>
        <li><a href="/pending">Response Filters</a></li>
        <ul>
          <li><a class="pending" href="/pending">Encryption response filter (eyaml)</a></li>
          <li><a class="pending" href="/pending">Substr response filter</a></li>
          <li><a class="pending" href="/pending">Writing your own reponse filters</a></li>
        </ul>



        </menusection>
      <footer>
      <br/><br/>
      <p>Sponsored by</p>
      <p><a href="http://www.enviatics.com"><img src="/images/logo_enviatics.png" alt="Enviatics"></a></p>
      <p><a href="http://baloise.github.io"><img src="/images/logo_baloise_Fotor.png" alt="baloise open source"></a></p>
      <br><br><br>
      <p><small>Hosted by <a href="https://pages.github.io">GitHub Pages</a></small></p>
      <p><small>Theme adapted from <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
        </headercontainer>
      <section>
        <h1 id="lookup_plugins">Lookup Plugins</h1>

<h2 id="introduction">Introduction</h2>

<p>Lookup plugins are a way to extend the functionality of <a href="/lookups">Jerakia lookups</a>.</p>

<p>Within a lookup we have access to both the request and all scope data sent by the requestor. Having access to read and modify these gives us a great deal of flexibility. Jerakia policies are written in Ruby DSL so there is nothing stopping you from putting any amount of functionality directly in the lookup. However, that makes for rather long and complex policies and isn’t easy to share or re-use. The recommended way therefore to add extra functionality to a lookup is to use the plugin mechanism.</p>

<p>Custom lookup plugins are installed into the <code>plugindir</code> location in the <a href="/basics/configure">configuration</a> and are searched relative to this path as <code>jerakia/lookup/plugin/&lt;name&gt;.rb</code>. Core plugins are installed with the main code base but used in the same way.</p>

<p>To use a plugin in a lookup it must be loaded using the :use parameter to the lookup block, for example to load the <a href="/plugins/hiera"><code>hiera</code> plugin</a> into your lookup you need to format your lookup block as;</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>lookup</span> <span class='ss'>:default</span><span class='p'>,</span> <span class='ss'>:use</span> <span class='o'>=&gt;</span> <span class='ss'>:hiera</span> <span class='k'>do</span>
  <span class='o'>.</span><span class='n'>.</span><span class='o'>.</span>
<span class='k'>end</span></code></pre></div>
<p>If you want to use more than one plugin, the argument to :use can also be an array</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>lookup</span> <span class='ss'>:default</span><span class='p'>,</span> <span class='ss'>:use</span> <span class='o'>=&gt;</span> <span class='o'>[</span> <span class='ss'>:hiera</span><span class='p'>,</span> <span class='ss'>:mystuff</span> <span class='o'>]</span> <span class='k'>do</span>
  <span class='o'>.</span><span class='n'>.</span><span class='o'>.</span>
<span class='k'>end</span></code></pre></div>
<p>Once a plugin is loaded into the lookup, it exposes it’s methods in the plugin.name namespace. For example, the hiera plugin has a method called rewrite_lookup which rewrites the lookup key and drops the namespace from the request, as described above. So to implement this functionality we would call the method using the plugin mechanism;</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>lookup</span> <span class='ss'>:default</span><span class='p'>,</span> <span class='ss'>:use</span> <span class='o'>=&gt;</span> <span class='ss'>:hiera</span> <span class='k'>do</span>
  <span class='o'>.</span><span class='n'>.</span><span class='o'>.</span>
  <span class='n'>plugin</span><span class='o'>.</span><span class='n'>hiera</span><span class='o'>.</span><span class='n'>rewrite_lookup</span>
<span class='k'>end</span></code></pre></div>
<h2 id="further_reading">Further reading</h2>

<p>See the blog post <a href="http://www.craigdunn.org/2015/09/extending-jerakia-with-lookup-plugins/">Extending Jerakia with Lookup Plugins</a> for more information on building lookup plugins.</p>
      </section>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
  </body>
</html>
