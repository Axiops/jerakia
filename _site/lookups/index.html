<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Jerakia</title>
    
    <link rel="stylesheet" href="/css/minimal.css">
    <link rel="stylesheet" href="/css/pygment_trac.css">
    <script src="/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <headercontainer>
        <header>
        <h1>Jerakia</h1>
        <p>A versatile data lookup system</p>
        <ul>
          <li><a href="https://rubygems.org/gems/jerakia/">Download <strong>Gem</strong></a></li>
          <li><a href="https://github.com/crayfishx/jerakia">View On <strong>GitHub</strong></a></li>
          <li><a href="https://forge.puppetlabs.com/crayfishx/jerakia">Install with<strong>Puppet</strong></a></li>
        </ul>
        </header>
        <menusection>
        <li><a href="/">Home</a></li>
        <br/>
        <li><a href="/basics">Basics</a></li>
        <ul>
          <li><a href="/basics/install">Installing</a></li>
          <li><a href="/basics/configure">Configuring</a></li>
          <li><a href="/basics/lookups">Understanding Jerakia Lookups</a></li>
          <li><a href="/basics/cli">Command line interface</a></li>
        </ul>
        <li><a href="/tutorial/">Quickstart Tutorial</a></li>
        <ul>
          <li><a href="/tutorial/installing">Installing Jerakia</a></li>
          <li><a href="/tutorial/config">Configuring</a></li>
          <li><a href="/tutorial/policy">Writing a policy</a></li>
          <li><a href="/tutorial/lookup">Writing a lookup</a></li>
          <li><a href="/tutorial/data">Populating data</a></li>
          <li><a href="/tutorial/command1">Running the jerakia command</a></li>
          <li><a href="/tutorial/override">Overriding data in the hierarchy</a></li>
          <li><a href="/tutorial/puppet">Integrating with Puppet</a></li>
        </ul>
        <li><a href="/lookups">Lookups</a></li>
        <ul>
          <li><a href="/lookups/plugins">Using lookup plugins</a></li>
          <li><a class="pending" href="/pending">Hiera lookup plugin</a></li>
          <li><a class="pending" href="/pending">Writing custom lookup plugins</a></li>
        </ul>
        <li><a href="/schema/">Schemas</a></li>
        <ul></ul>
        <li><a href="/datasources">Datasources</a></li>
        <ul>
          <li><a href="/datasources/file">File datasource</a></li>
          <li><a href="/datasources/http">HTTP datasource</a></li>
          <li><a href="/datasources/dummy">Dummy datasource</a></li>
          <li><a class="pending" href="/pending">Writing datasources</a></li>
        </ul>
        <li><a href="/pending">Response Filters</a></li>
        <ul>
          <li><a class="pending" href="/pending">Encryption response filter (eyaml)</a></li>
          <li><a class="pending" href="/pending">Substr response filter</a></li>
          <li><a class="pending" href="/pending">Writing your own reponse filters</a></li>
        </ul>



        </menusection>
      <footer>
      <br/><br/>
      <p>Sponsored by</p>
      <p><a href="http://www.enviatics.com"><img src="/images/logo_enviatics.png" alt="Enviatics"></a></p>
      <p><a href="http://baloise.github.io"><img src="/images/logo_baloise_Fotor.png" alt="baloise open source"></a></p>
      <br><br><br>
      <p><small>Hosted by <a href="https://pages.github.io">GitHub Pages</a></small></p>
      <p><small>Theme adapted from <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
        </headercontainer>
      <section>
        <h1 id="jerakia_lookups">Jerakia Lookups</h1>

<p>Lookup blocks define where and how to source the data. At a minmum a lookup block must specify a <code>datasource</code> to pass the request to. Data sources can optionally take a hash of arguments. Look at each datasourceâ€™s documentation for information on what options they support.</p>

<p>A policy can contain many lookups and each one is evaluated in order within the policy.</p>

<p>Supported methods are</p>

<ul>
<li><code>datasource, {opts}</code> data source with corresponding options</li>

<li><code>invalidate</code> disable this lookup</li>

<li><code>scope</code> return the scope object</li>

<li><code>output_filter</code> add an output handler to this request</li>

<li><code>stop</code> Do not proceed to the next lookup <em>if this lookup is deemed valid</em>, regardless of whether data is returned</li>

<li><code>confine</code> Confine this lookup to a set of criteria</li>

<li><code>exclude</code> Exclude this lookup if the criteria is matched</li>
</ul>

<h2 id="example">Example</h2>

<p>Here is an example of a Jerakia lookup contained within a policy</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>policy</span> <span class='ss'>:default</span> <span class='k'>do</span>
  <span class='n'>lookup</span> <span class='ss'>:main</span> <span class='k'>do</span>
    <span class='n'>datasource</span> <span class='ss'>:file</span><span class='p'>,</span> <span class='p'>{</span>
      <span class='ss'>:format</span> <span class='o'>=&gt;</span> <span class='ss'>:yaml</span><span class='p'>,</span>
      <span class='ss'>:extension</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;yaml&#39;</span><span class='p'>,</span>
      <span class='ss'>:docroot</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;/etc/jerakia/data&#39;</span><span class='p'>,</span>
      <span class='ss'>:searchpath</span> <span class='o'>=&gt;</span> <span class='o'>[</span>
        <span class='n'>scope</span><span class='o'>[</span><span class='ss'>:certname</span><span class='o'>]</span><span class='p'>,</span>
        <span class='n'>scope</span><span class='o'>[</span><span class='ss'>:environment</span><span class='o'>]</span><span class='p'>,</span>
        <span class='s1'>&#39;global&#39;</span><span class='p'>,</span>
      <span class='o'>]</span>
    <span class='p'>},</span>
  <span class='k'>end</span>
<span class='k'>end</span></code></pre></div>
<h2 id="defining_lookups">Defining Lookups</h2>

<p>Lookups are defined inside policies using the <code>lookup</code> method.</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>lookup</span> <span class='ss'>:main</span> <span class='k'>do</span>
<span class='k'>end</span></code></pre></div>
<p>The lookup method also supports the <code>:use</code> flag to <a href="/lookups/plugins">load plugins</a></p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>lookup</span> <span class='ss'>:main</span><span class='p'>,</span> <span class='ss'>:use</span> <span class='o'>=&gt;</span> <span class='ss'>:hiera</span> <span class='k'>do</span>
<span class='k'>end</span></code></pre></div>
<h2 id="lookup_methods">Lookup Methods</h2>

<h4 id=""><code>datasource</code></h4>

<p>The datasource option takes a datasource name as the first argument and options to be passed to the datasource as a hash in the second argument</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>datasource</span> <span class='p'>:</span><span class='o'>&lt;</span><span class='n'>datasource</span><span class='o'>&gt;</span><span class='p'>,</span> <span class='p'>{</span> <span class='ss'>:opt</span> <span class='o'>=&gt;</span> <span class='n'>value</span><span class='p'>,</span> <span class='ss'>:opt</span> <span class='o'>=&gt;</span> <span class='n'>value</span> <span class='p'>}</span></code></pre></div>
<p>Example:</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>datasource</span> <span class='ss'>:file</span><span class='p'>,</span> <span class='p'>{</span>
  <span class='ss'>:format</span> <span class='o'>=&gt;</span> <span class='ss'>:yaml</span><span class='p'>,</span>
  <span class='ss'>:docroot</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;/var/lib/jerakia/data&#39;</span><span class='p'>,</span>
  <span class='ss'>:searchpath</span> <span class='o'>=&gt;</span> <span class='o'>[</span>
    <span class='n'>scope</span><span class='o'>[</span><span class='ss'>:certname</span><span class='o'>]</span><span class='p'>,</span>
    <span class='n'>scope</span><span class='o'>[</span><span class='ss'>:environment</span><span class='o'>]</span><span class='p'>,</span>
    <span class='s1'>&#39;global&#39;</span><span class='p'>,</span>
  <span class='o'>]</span>
<span class='p'>},</span></code></pre></div>
<p><a href="/datasources">Learn more about datasources</a></p>

<h4 id="_and_"><code>confine</code> and <code>exclude</code></h4>

<p>The <code>confine</code> and <code>exclude</code> lookup methods allow you to specify when a lookup should be run or should be skipped. When you have multiple lookups defined in a policy you may not want to always run all lookups.</p>

<p>Both arguments take a subject as the first argument and the criteria as the second argument.</p>

<p>For example, to only run a lookup if the namespace matches <code>apache</code> you can specify</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>lookup</span> <span class='ss'>:special</span> <span class='k'>do</span>
   <span class='o'>.</span><span class='n'>.</span><span class='o'>.</span>
   <span class='n'>confine</span> <span class='n'>request</span><span class='o'>.</span><span class='n'>namespace</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]</span><span class='p'>,</span> <span class='s2'>&quot;apache&quot;</span>
<span class='k'>end</span></code></pre></div>
<p>The second argument can be a regex, and multiple criteria can be passed in as an array, eg:</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>lookup</span> <span class='ss'>:special</span> <span class='k'>do</span>
  <span class='o'>.</span><span class='n'>.</span><span class='o'>.</span>
  <span class='n'>confine</span> <span class='n'>request</span><span class='o'>.</span><span class='n'>namespace</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span>
    <span class='sr'>/website_.*/</span><span class='p'>,</span>
    <span class='s2'>&quot;apache&quot;</span><span class='p'>,</span>
    <span class='s2'>&quot;php&quot;</span>
  <span class='o'>]</span>
<span class='k'>end</span></code></pre></div>
<p>The <code>exclude</code> method has the oposite effect of <code>confine</code> and will cause the lookup to be run <em>unless</em> the condition matches.</p>

<h4 id="_2"><code>invalidate</code></h4>

<p>Calling the <code>invalidate</code> method will cause Jerakia to skip this lookup and proceed to the next one (if applicable)</p>

<h4 id="_3"><code>stop</code></h4>

<p>The stop method will prevent Jerakia from running any more lookups after the containing lookup, however, it only has effect if the containing lookup is valid. If the lookup is invalidated with <code>confine</code>, <code>exclude</code> or <code>invalidate</code> then Jerakia will proceed to the next lookup.</p>

<h4 id="_4"><code>output_filter</code></h4>

<p>The <code>output_filter</code> lookup method will send the data returned from the datasource to the response filter specified as the first argument, for example, if you are using the eyaml encryption response filter, then you need an output_filter method to enable that in your lookup</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>lookup</span> <span class='ss'>:main</span> <span class='k'>do</span>
  <span class='o'>.</span><span class='n'>.</span><span class='o'>.</span>
  <span class='n'>output_filter</span> <span class='ss'>:encryption</span>
<span class='k'>end</span></code></pre></div>
<h4 id="_5"><code>scope</code></h4>

<p>The scope method returns the key/value scope data from the requestor as a hash.</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>scope</span><span class='o'>[</span><span class='ss'>:value</span><span class='o'>]</span></code></pre></div>
<h2 id="further_examples">Further examples</h2>

<p>Here is an example of a much more complex policy that contains a dedicated lookup via an HTTP datasource that is used when configuring PHP or Apache, but a default file based lookup for everything else.</p>
<div class='highlight'><pre><code class='language-ruby' data-lang='ruby'><span class='n'>policy</span> <span class='ss'>:default</span> <span class='k'>do</span>

  <span class='n'>lookup</span> <span class='ss'>:webserver</span> <span class='k'>do</span>
    <span class='n'>datasource</span> <span class='ss'>:http</span><span class='p'>,</span> <span class='p'>{</span>
      <span class='ss'>:host</span>   <span class='o'>=&gt;</span> <span class='s1'>&#39;127.0.0.1&#39;</span><span class='p'>,</span>
      <span class='ss'>:port</span>   <span class='o'>=&gt;</span> <span class='mi'>5984</span><span class='p'>,</span>
      <span class='ss'>:output</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;json&quot;</span><span class='p'>,</span>
      <span class='ss'>:paths</span>  <span class='o'>=&gt;</span> <span class='o'>[</span>
        <span class='s2'>&quot;/configuration/#[scope[:environment]&quot;</span><span class='p'>,</span>
        <span class='s2'>&quot;/configuration/global&quot;</span><span class='p'>,</span>
      <span class='o'>]</span>
    <span class='p'>}</span>
 
    <span class='n'>confine</span> <span class='n'>request</span><span class='o'>.</span><span class='n'>namespace</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>]</span><span class='p'>,</span> <span class='o'>[</span>
      <span class='s2'>&quot;apache&quot;</span><span class='p'>,</span>
      <span class='s2'>&quot;php&quot;</span><span class='p'>,</span>
    <span class='o'>]</span>
 
    <span class='n'>stop</span>
  <span class='k'>end</span>
 
  <span class='n'>lookup</span> <span class='ss'>:main</span><span class='p'>,</span> <span class='k'>do</span>
    <span class='n'>datasource</span> <span class='ss'>:file</span><span class='p'>,</span> <span class='p'>{</span>
      <span class='ss'>:format</span>     <span class='o'>=&gt;</span> <span class='ss'>:yaml</span><span class='p'>,</span>
      <span class='ss'>:docroot</span>    <span class='o'>=&gt;</span> <span class='s2'>&quot;/var/lib/jerakia&quot;</span><span class='p'>,</span>
      <span class='ss'>:searchpath</span> <span class='o'>=&gt;</span> <span class='o'>[</span>
        <span class='s2'>&quot;hostname/</span><span class='si'>#{</span><span class='n'>scope</span><span class='o'>[</span><span class='ss'>:fqdn</span><span class='o'>]</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>,</span>
        <span class='s2'>&quot;environment/</span><span class='si'>#{</span><span class='n'>scope</span><span class='o'>[</span><span class='ss'>:environment</span><span class='o'>]</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>,</span>
        <span class='s2'>&quot;common&quot;</span>
      <span class='o'>]</span><span class='p'>,</span>
    <span class='p'>}</span>
  <span class='k'>end</span>
<span class='k'>end</span></code></pre></div>
<p>In this example, the first lookup will be evaluated for any lookup that is in the <code>apache</code> or <code>php</code> namespace. The <code>stop</code> method tells Jerakia to only use this lookup if the criteria of <code>confine</code> deem this to be a valid lookup. If the namespace does not match, then this lookup is ignored and the next lookup, <code>main</code>, will be used.</p>
      </section>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
  </body>
</html>
